function Speedtest(){this._serverList=[],this._selectedServer=null,this._settings={},this._state=0}Speedtest.prototype={constructor:Speedtest,getState:function(){return this._state},setParameter:function(t,e){if(3==this._state)throw"You cannot change the test settings while running the test";this._settings[t]=e,"telemetry_extra"===t&&(this._originalExtra=this._settings.telemetry_extra)},_checkServerDefinition:function(t){try{if("string"!=typeof t.name)throw"Name string missing from server definition (name)";if("string"!=typeof t.server)throw"Server address string missing from server definition (server)";if("/"!=t.server.charAt(t.server.length-1)&&(t.server+="/"),0==t.server.indexOf("//")&&(t.server=location.protocol+t.server),"string"!=typeof t.dlURL)throw"Download URL string missing from server definition (dlURL)";if("string"!=typeof t.ulURL)throw"Upload URL string missing from server definition (ulURL)";if("string"!=typeof t.pingURL)throw"Ping URL string missing from server definition (pingURL)";if("string"!=typeof t.getIpURL)throw"GetIP URL string missing from server definition (getIpURL)"}catch(t){throw"Invalid server definition"}},addTestPoint:function(t){if(this._checkServerDefinition(t),0==this._state&&(this._state=1),1!=this._state)throw"You can't add a server after server selection";this._settings.mpot=!0,this._serverList.push(t)},addTestPoints:function(t){for(var e=0;e<t.length;e++)this.addTestPoint(t[e])},loadServerList:function(t,e){if(0==this._state&&(this._state=1),1!=this._state)throw"You can't add a server after server selection";this._settings.mpot=!0;var s=new XMLHttpRequest;s.onload=function(){try{for(var t=JSON.parse(s.responseText),r=0;r<t.length;r++)this._checkServerDefinition(t[r]);this.addTestPoints(t),e(t)}catch(t){e(null)}}.bind(this),s.onerror=function(){e(null)},s.open("GET",t),s.send()},getSelectedServer:function(){if(this._state<2||null==this._selectedServer)throw"No server is selected";return this._selectedServer},setSelectedServer:function(t){if(this._checkServerDefinition(t),3==this._state)throw"You can't select a server while the test is running";this._selectedServer=t,this._state=2},selectServer:function(t){if(1!=this._state){if(0==this._state)throw"No test points added";if(2==this._state)throw"Server already selected";if(this._state>=3)throw"You can't select a server while the test is running"}if(this._selectServerCalled)throw"selectServer already called";this._selectServerCalled=!0;for(var e=function(t,e){var s=!0;/MSIE.(\d+\.\d+)/i.test(navigator.userAgent)&&(s=!1);var r=function(t,e){t+=(t.match(/\?/)?"&":"?")+"cors=true";var r=new XMLHttpRequest,i=(new Date).getTime();if(r.onload=function(){if(0==r.responseText.length){var s=(new Date).getTime()-i;try{var n=performance.getEntriesByName(t),o=(n=n[n.length-1]).responseStart-n.requestStart;o<=0&&(o=n.duration),o>0&&o<s&&(s=o)}catch(t){}e(s)}else e(-1)}.bind(this),r.onerror=function(){e(-1)}.bind(this),r.open("GET",t),s)try{r.timeout=2e3,r.ontimeout=r.onerror}catch(t){}r.send()}.bind(this),i=function(t,e){var s=0;if(t.pingT=-1,-1==t.server.indexOf(location.protocol))e();else{var i=function(){3!=s++?r(t.server+t.pingURL,function(s){s>=0?((s<t.pingT||-1==t.pingT)&&(t.pingT=s),s<500?i():e()):e()}.bind(this)):e()}.bind(this);i()}}.bind(this),n=0,o=function(){for(var s=null,r=0;r<t.length;r++)-1!=t[r].pingT&&(null==s||t[r].pingT<s.pingT)&&(s=t[r]);e(s)}.bind(this),a=function(){n!=t.length?i(t[n++],a):o()}.bind(this);a()}.bind(this),s=[],r=0;r<6;r++)s[r]=[];for(r=0;r<this._serverList.length;r++)s[r%6].push(this._serverList[r]);var i=0,n=null;for(r=0;r<6;r++)e(s[r],function(e){null!=e&&(null==n||e.pingT<n.pingT)&&(n=e),6==++i&&(this._selectedServer=n,this._state=2,t&&t(n))}.bind(this))},start:function(){if(3==this._state)throw"Test already running";if(this.worker=new Worker("speedtest_worker.js?r="+Math.random()),this.worker.onmessage=function(t){if(t.data!==this._prevData){this._prevData=t.data;var e=JSON.parse(t.data);try{this.onupdate&&this.onupdate(e)}catch(t){console.error("Speedtest onupdate event threw exception: "+t)}if(e.testState>=4){clearInterval(this.updater),this._state=4;try{this.onend&&this.onend(5==e.testState)}catch(t){console.error("Speedtest onend event threw exception: "+t)}}}}.bind(this),this.updater=setInterval(function(){this.worker.postMessage("status")}.bind(this),200),1==this._state)throw"When using multiple points of test, you must call selectServer before starting the test";2==this._state&&(this._settings.url_dl=this._selectedServer.server+this._selectedServer.dlURL,this._settings.url_ul=this._selectedServer.server+this._selectedServer.ulURL,this._settings.url_ping=this._selectedServer.server+this._selectedServer.pingURL,this._settings.url_getIp=this._selectedServer.server+this._selectedServer.getIpURL,void 0!==this._originalExtra?this._settings.telemetry_extra=JSON.stringify({server:this._selectedServer.name,extra:this._originalExtra}):this._settings.telemetry_extra=JSON.stringify({server:this._selectedServer.name})),this._state=3,this.worker.postMessage("start "+JSON.stringify(this._settings))},abort:function(){if(this._state<3)throw"You cannot abort a test that's not started yet";this._state<4&&this.worker.postMessage("abort")}};